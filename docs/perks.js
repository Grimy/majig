"use strict";function remove(a){a.parentNode.removeChild(a)}function switch_theme(){var a=$("#dark");localStorage.dark=(a.disabled=!a.disabled)?"":"1"}function show_alert(a,b){$("#alert").innerHTML+="<p class="+a+">\n			<span class=badge onclick='remove(this.parentNode)'>×</span>\n			"+b+"\n		</p>"}function create_share(a){var b=localStorage.notation+":";b+=$$("input,select").map(function(a){return a.value.replace(":","")}).join(":");var c=location.href.replace(/[#?].*/,"");c+="?"+LZString.compressToBase64(b);var d="https://api-ssl.bitly.com/v3/shorten?longUrl="+encodeURIComponent(c);d+="&login=grimy&apiKey=R_7ea82c1cec394d1ca5cf4da2a7f7ddd9",a=a||function(a){return show_alert("ok","Your share link is <a href="+a+">"+a)};var e=new XMLHttpRequest;e.open("GET",d,!0),e.onload=function(){return a(JSON.parse(e.responseText).data.url||c)},e.send()}function exit_share(){history.pushState({},"","perks.html"),$("textarea").removeEventListener("click",exit_share),$$("[data-saved]").forEach(function(a){return a.value=localStorage[a.id]||a.value})}function load_share(a){var b=LZString.decompressFromBase64(a).split(":"),c=localStorage.notation;localStorage.notation=b.shift(),$$("input,select").forEach(function(a){return a.value=b.shift()}),$("textarea").addEventListener("click",exit_share),localStorage.notation=c||1}function prettify(a){if(0>a)return"-"+prettify(-a);if(1e4>a)return+a.toPrecision(4)+"";if("0"===localStorage.notation)return a.toExponential(2).replace("+","");for(var b=0;a>=999.5;)a/=1e3,++b;var c=notations[localStorage.notation||1],d=b>c.length?"e"+3*b:c[b-1];return+a.toPrecision(3)+d}function parse_suffixes(a){a=a.replace(/\*.*|[^--9+a-z]/gi,"");for(var b=notations["3"===localStorage.notation?3:1],c=b.length;c>0;--c)a=a.replace(new RegExp(b[c-1]+"$","i"),"E"+3*c);return+a}function input(a){return parse_suffixes($("#"+a).value)}function check_input(a){var b=isFinite(parse_suffixes(a.value)),c="3"===localStorage.notation?"alphabetic ":"";a.setCustomValidity(b?"":"Invalid "+c+"number: "+a.value)}function handle_paste(a,b,c){var d=a.clipboardData.getData("text/plain").replace(/\s/g,"");try{game=JSON.parse(LZString.decompressFromBase64(d));var e=4.7;game.global.version>e+.009?show_alert("warning","This calculator only supports up to v"+e+" of Trimps, but your save is from v"+game.global.version+". Results may be inaccurate."):game.global.version<e&&show_alert("ok","Trimps v"+e+" is out! Your save is still on v"+game.global.version+", so you should refresh the game’s page.")}catch(f){throw"Your clipboard did not contain a valid Trimps save. Open the game, click “Export” then “Copy to Clipboard”, and try again."}localStorage.notation=game.options.menu.standardNotation.enabled;for(var g in game.talents)game.talents[g]=game.talents[g].purchased;b(),c()}function validate_fixed(){try{parse_perks($("#fixed").value,"l"),$("#fixed").setCustomValidity("")}catch(a){$("#fixed").setCustomValidity(a)}}function select_preset(a){b=presets[a],$("#weight-he").value=b[0],$("#weight-atk").value=b[1],$("#weight-hp").value=b[2],$("#weight-xp").value=floor((+presets[a][0]+ +presets[a][1]+ +presets[a][2])/5).toString();var b}function handle_respec(a){var b=game?game.resources.helium.owned:0;$("#helium").value=(input("helium")+b*(a?-1:1)).toString()}function update_dg(){function a(a){m+=a*c*sqrt(min(d,n)),n-=h}var b=input("zone")/2+115,c=5e8+5e7*game.generatorUpgrades.Efficiency.upgrades,d=3+.4*game.generatorUpgrades.Capacity.upgrades,e=game.permanentGeneratorUpgrades.Storage.owned?1.5*d:d,f=230+2*game.generatorUpgrades.Supply.upgrades,g=game.generatorUpgrades.Overclocker.upgrades;g=g&&1-.5*pow(.99,g-1);var h=game.permanentGeneratorUpgrades.Slowburn.owned?.4:.5,i=game.talents.magmaFlow?18:16,j=game.talents.quickGen?1.03:1.02,k=game.talents.hyperspeed2?(game.global.highestLevelCleared+1)/2:0,l=.5*game.talents.blacksmith+.25*game.talents.blacksmith2+.15*game.talents.blacksmith3;l*=game.global.highestLevelCleared+1;for(var m=0,n=0,o=0,p=230;b>=p;++p){n+=i*(.01*min(p,f)-2.1);var q=ceil(60/pow(j,floor((p-230)/3)));for(o+=p>l?28:p>k?20:15;o>=q;)o-=q,a(1);for(;n>e;)a(g);m*=1.009}for(;n>=h;)a(1);$("#dg").value=prettify(m)}function read_save(){localStorage.zone||($("#zone").value=game.stats.highestVoidMap.valueTotal||game.global.highestLevelCleared);var a=input("zone");localStorage["weight-he"]||localStorage["weight-atk"]||localStorage["weight-hp"]||($$("#preset > *").forEach(function(a){a.selected=parseInt(a.innerHTML.replace("z",""))<game.global.highestLevelCleared}),select_preset($("#preset").value));var b=game.global.heliumLeftover;for(var c in game.portal)b+=game.portal[c].heliumSpent;var d=Object.keys(game.portal).filter(function(a){return!game.portal[a].locked});game.global.canRespecPerks||(d=d.map(function(a){return a+">"+game.portal[a].level}));var e=game.talents.turkimp4?1:game.talents.turkimp3?.6:game.talents.turkimp2?.4:game.talents.turkimp?.3:.25,f=1+e,g=1+.333*e,h=min(floor((a-101)/100),game.global.spiresCompleted);g*=100>a?.7:1+(game.talents.stillRowing?.3:.2)*h;var i=27*game.unlocks.imps.Jestimp+15*game.unlocks.imps.Chronoimp,j=60>a?0:85>a?7:160>a?10:185>a?14:20;i+=(game.talents.mapLoot2?5:4)*j;for(var k=0,l=game.global.StaffEquipped.mods||[];k<l.length;k++){var m=l[k];"MinerSpeed"===m[0]?f*=1+.01*m[1]:"metalDrop"===m[0]&&(g*=1+.01*m[1])}update_dg(),$("#helium").value=b+($("#respec").checked?0:game.resources.helium.owned),$("#unlocks").value=d.join(","),$("#whipimp").checked=game.unlocks.imps.Whipimp,$("#magnimp").checked=game.unlocks.imps.Magnimp,$("#tauntimp").checked=game.unlocks.imps.Tauntimp,$("#venimp").checked=game.unlocks.imps.Venimp,$("#chronojest").value=prettify(i),$("#prod").value=($("#prod").value.indexOf("0*")?"":"0*")+prettify(f),$("#loot").value=($("#loot").value.indexOf("0*")?"":"0*")+prettify(g),$("#breed-timer").value=prettify(game.talents.patience?45:30)}function parse_inputs(a){var b={he_left:input("helium"),zone:parseInt($("#zone").value),perks:parse_perks($("#fixed").value,$("#unlocks").value),weight:{helium:input("weight-he"),attack:input("weight-atk"),health:input("weight-hp"),xp:input("weight-xp"),trimps:0},fluffy:{xp:game?game.global.fluffyExp:0,prestige:game?game.global.fluffyPrestige:0},mod:{storage:.125,soldiers:0,dg:"nerfed"==a?0:input("dg"),tent_city:"tent"==a,whip:$("#whipimp").checked,magn:$("#magnimp").checked,taunt:$("#tauntimp").checked,ven:$("#venimp").checked,chronojest:input("chronojest"),prod:input("prod"),loot:input("loot"),breed_timer:input("breed-timer")}};return"nerfed"==a&&(b.he_left=1e8,b.zone=200,b.mod.dg=0),"trapper"==a&&(b.mod.soldiers=game.resources.trimps.owned,b.mod.prod=0),"spire"==a&&(b.mod.prod=b.mod.loot=0),"carp"==a&&(b.mod.prod=b.mod.loot=0,b.weight.trimps=1e6),"metal"==a&&(b.mod.prod=0),"trimp"==a&&(b.mod.soldiers=1),"metal"==a&&(b.mod.prod=0),b}function display(a){var b=a[0],c=a[1];$("#results").style.opacity="1",$("#info").innerText=localStorage.more?"Less info":"More info",$("#he-left").innerHTML=prettify(b)+" Helium Left Over",$("#perks").innerHTML=c.filter(function(a){return!a.locked}).map(function(a){var b=a.name,c=a.level,d=a.cap,e=a.spent,f=game?c-game.portal[a.name].level:0,g=f?" ("+(f>0?"+":"-")+prettify(abs(f))+")":"",h=f>0?"adding":0>f?"remove":c>=d?"capped":"";return"<div class='perk "+h+" "+localStorage.more+"'>"+("<b>"+b.replace("_"," ")+"</b><br>")+("Level: <b>"+prettify(c)+g+"</b><br><span class=more>")+("Price: "+(c>=d?"∞":prettify(a.cost()))+"<br>")+("Spent: "+prettify(e)+"</span></div>")}).join("")}function main(){var a=$("#preset").value;if("trapper"==a&&(!game||"Trapper"!=game.global.challengeActive))throw"This preset requires a save currently running Trapper². Start a new run using “Trapper² (initial)”, export, and try again.";var b=parse_inputs(a),c=game?game.global.highestLevelCleared:999;(a.match(/trimp|coord/)&&b.zone>=c/2||"trapper"===a&&b.zone>=c-40)&&show_alert("warning","Your target zone seems too high for this c², try lowering it."),"spire"==a&&game&&game.global.world!=100*(2+game.global.lastSpireCleared)&&show_alert("warning","This preset is meant to be used mid-run, when you’re done farming for the Spire."),display(optimize(b))}function toggle_info(){localStorage.more=localStorage.more?"":"more",$$(".perk").forEach(function(a){return a.classList.toggle("more")}),$("#info").innerText=localStorage.more?"Less info":"More info"}function parse_perks(a,b){var c=[new Perk("Looting_II",1e5,1e4,1/0,1e4),new Perk("Carpentry_II",1e5,1e4,1/0,1e4),new Perk("Motivation_II",5e4,1e3,1/0,1e4),new Perk("Power_II",2e4,500,1/0,1e4),new Perk("Toughness_II",2e4,500,1/0,1e4),new Perk("Capable",1e8,0,10,1e4,900),new Perk("Cunning",1e11,0,1/0,1e4),new Perk("Curious",1e14,0,1/0,1e4),new Perk("Overkill",1e6,0,30,1e4),new Perk("Resourceful",5e4,0,1/0,1e6),new Perk("Coordinated",15e4,0,1/0,1e4),new Perk("Siphonology",1e5,0,3,1e4),new Perk("Anticipation",1e3,0,10,1e4),new Perk("Resilience",100,0,1/0,1e4),new Perk("Meditation",75,0,7,1e4),new Perk("Relentlessness",75,0,10,1e4),new Perk("Carpentry",25,0,1/0,1e4),new Perk("Artisanistry",15,0,1/0,1e4),new Perk("Range",1,0,10,1e4),new Perk("Agility",4,0,20,1e4),new Perk("Bait",4,0,1/0,1e7),new Perk("Trumps",3,0,1/0,1e8),new Perk("Pheromones",3,0,1/0,1e6),new Perk("Packrat",3,0,1/0,1e7),new Perk("Motivation",2,0,1/0,1e4),new Perk("Power",1,0,1/0,1e4),new Perk("Toughness",1,0,1/0,1e4),new Perk("Looting",1,0,1/0,1e4)];b.match(/>/)||(b=b.replace(/(?=,|$)/g,">0"));for(var d=function(a){var b=a.match(/(\S+) *([<=>])=?(.*)/);if(!b)throw"Enter a list of perk levels, such as “power=42, toughness=51”.";var d=b[1].match(/2$|II$/),e=b[1].replace(/[ _]?(2|II)/i,"").replace(/^OK/i,"O").replace(/^Looty/i,"L"),f=new RegExp("^"+e+"[a-z]*"+(d?"_II":"")+"$","i"),g=c.filter(function(a){return a.name.match(f)});if(g.length>1)throw"Ambiguous perk abbreviation: "+b[1]+".";if(g.length<1)throw"Unknown perk: "+b[1]+".";var h=parse_suffixes(b[3]);if(!isFinite(h))throw"Invalid number: "+b[3]+".";g[0].locked=!1,">"!=b[2]&&(g[0].cap=h),"<"!=b[2]&&(g[0].must=h)},e=0,f=(b+","+a).split(/,/).filter(function(a){return a});e<f.length;e++){var g=f[e];d(g)}return c}function optimize(a){function b(){return 1+ +(M.level<3)+ceil(10*mult(M,-5))}function c(a){var c=s.storage*mult(C,-5)/add(Q,20),d=ka()*s.magn/b(),e=a?0:ja()*add(H,1)*s.prod,f=.1*s.chronojest*e*d;return ea*(e+d*s.loot+f)*(1-c)}function d(a){var b=ia[a]*mult(K,-5),d=1.136,e=log(1+c()*la()/b)/log(ha.cost);return e>ga+.45&&(d=log(1+.2*pow(ha.cost,e-ga))/log(1.2),e=ga),d*pow(ha[a],e)}function e(a,b){return a*=4*mult(C,-5),log(1+c(!0)*la()*(b-1)/a)/log(b)}function f(){return max(o-229,0)}function g(){var a=e(2e6,1.06)/(1+.1*min(f(),20)),b=.0085*(o>=60?.1:1)*pow(1.1,floor(o/5));return b*pow(1.01,a)*add(P,10)*s.ven}function h(){var a=1+.25*mult(D,-2),b=(s.soldiers||la())/3;s.soldiers>1&&(b+=36e3*add(N,100));var c=log(b/ma[D.level])/log(a),d=o-1+(f()?100:0);return ma[0]*pow(1.25,min(c,d))}function i(){var a=(.15+d("attack"))*pow(.8,f());return a*=add(S,5)*add(w,1),a*=add(I,5*add(I,30)),a*=pow(1+E.level,.1)*add(L,1),a*=add(F,6),h()*a}function j(){var a=(.6+d("health"))*pow(.8,f());a*=add(T,5)*add(x,1)*mult(G,10);var c=e(400,1.185),i=(c*log(1.185)-log(1+c))/log(1.1)+25-ca,j=.04*c*pow(1+ca/100,c)*(1+da*i),k=60;if(70>o){var l=log(1+h()*g()/add(N,100))/log(1+g());k=l/b()}else{var m=1+.25*mult(D,-2),n=o-1+(f()?100:0),p=ma[D.level]*pow(m,n),q=min(p/la(),1/3),r=q>1e-9?10*(pow(.5/(.5-q),.1/s.breed_timer)-1):q/s.breed_timer,t=log(g()/r)/-log(.98);a*=pow(1.01,t)}return a/=k,60>o?j+=d("block"):j=min(j,4*a),h()*(j+a)}function k(){for(var a=50*add(z,25)*add(A,60),b=0,c=1e3*pow(5,p.prestige)*(mult(y,300)-1)/3-p.xp,d=301;o>d;++d)b+=a*=1.015;return max(.2,min(b,c))}function l(){var a=0;for(var b in r)if(r[b]){var c=ua[b]();if(!isFinite(c))throw Error(b+" is "+c);a+=r[b]*log(c)}return a}function m(){for(var a,b=0,c=l(),d=0,e=q;d<e.length;d++){var f=e[d];if(!(f.locked||f.level>=f.cap||f.cost()>n)){f.level+=f.pack;var g=l()-c;f.level-=f.pack;var h=g/f.cost();h>=b&&(b=h,a=f)}}return a}for(var n=a.he_left,o=a.zone,p=a.fluffy,q=a.perks,r=a.weight,s=a.mod,t=q[0],u=q[1],v=q[2],w=q[3],x=q[4],y=q[5],z=q[6],A=q[7],B=q[8],C=q[9],D=q[10],E=q[11],F=q[12],G=q[13],H=q[14],I=q[15],J=q[16],K=q[17],L=q[18],M=q[19],N=q[20],O=q[21],P=q[22],Q=q[23],R=q[24],S=q[25],T=q[26],U=q[27],V=0,W=q;V<W.length;V++){var X=W[V];X.name.endsWith("_II")&&(X.pack=pow(10,max(0,floor(log(n)/log(100)-4.2))))}for(var Y=0,Z=["whip","magn","taunt","ven"];Y<Z.length;Y++){var $=Z[Y];s[$]=pow(1.003,99*o*.03*s[$])}for(var _=pow(1.25,o)*pow(o>100?1.28:1.2,max(o-59,0)),aa=max(0,min(o-60,o/2-25,o/3-12,o/5,o/10+17,39)),ba=pow(1.25,min(o/2,30)+aa),ca=o>=25?floor(min(o/5,9+o/25,15)):0,da=(20+o-o%5)/100,ea=600*s.whip*_,fa=pow(o-19,2),ga=o/5+ +(5>(o-1)%10),ha={cost:pow(1.069,.85*(60>o?57:53)),attack:pow(1.19,13),health:pow(1.19,14),block:pow(1.19,10)},ia={attack:211*(r.attack+r.health)/r.attack,health:248*(r.attack+r.health)/r.health,block:5*(r.attack+r.health)/r.health},ja=function(){return add(R,5)*add(v,1)},ka=function(){return add(U,5)*add(t,.25)},la=s.tent_city?function(){var a=mult(J,10)*add(u,.25),b=add(O,20);return 10*(s.taunt+b*(s.taunt-1)*111)*a}:function(){var a=mult(J,10)*add(u,.25),b=3+max(log(c()/ea*a/mult(C,-5)),0),d=add(O,20)*o;return 10*(ba*b+d)*a*s.taunt+s.dg*a},ma=[],na=0;na<=log(1+n/5e5)/log(1.3);++na){for(var oa=1+.25*pow(.98,na),pa=1,qa=0;100>qa;++qa)pa=ceil(pa*oa);ma[na]=pa/pow(oa,100)}var ra=function(){return 1/mult(M,-5)},sa=function(){return fa*ka()+45},ta=function(){return max(.2,B.level)},ua={agility:ra,helium:sa,xp:k,attack:i,health:j,overkill:ta,trimps:la};s.loot*=20.8,r.agility=(r.helium+r.attack)/2,r.overkill=.25*r.attack*(2-pow(.9,r.helium/r.attack)),o>110&&s.soldiers<=1&&0==N.must&&(N.cap=0),y.must||(y.must=min(10,floor(log(.003*p.xp/pow(5,p.prestige)+1)/log(4))));for(var va=0,wa=q;va<wa.length;va++)for(var X=wa[va];X.level<X.must;)n-=X.cost(),X.level+=X.pack;if(0>n)throw"You don’t have enough Helium to afford your Fixed Perks.";for(var xa=void 0;xa=m();){for(var ya=0;xa.level<xa.cap&&(xa.level<xa.must||ya<n/xa.free);)n-=xa.cost(),ya+=xa.cost(),xa.level+=xa.pack,xa.level==1e3*xa.pack&&(xa.pack*=10);xa.spent+=ya}for(var za=0,Aa=q;za<Aa.length;za++){var X=Aa[za];console.log(X.name,"=",X.level)}return[n,q]}var abs=Math.abs,ceil=Math.ceil,floor=Math.floor,log=Math.log,max=Math.max,min=Math.min,pow=Math.pow,round=Math.round,sqrt=Math.sqrt,$=function(a){return document.querySelector(a)},$$=function(a){return[].slice.apply(document.querySelectorAll(a))};$("#dark").disabled=!localStorage.dark;var notations=[[],"KMBTQaQiSxSpOcNoDcUdDdTdQadQidSxdSpdOdNdVUvDvTvQavQivSxvSpvOvNvTgUtgDtgTtgQatgQitgSxtgSptgOtgNtgQaaUqaDqaTqaQaqaQiqaSxqaSpqaOqaNqaQiaUqiDqiTqiQaqiQiqiSxqiSpqiOqiNqiSxaUsxDsxTsxQasxQisxSxsxSpsxOsxNsxSpaUspDspTspQaspQispSxspSpspOspNspOgUogDogTogQaogQiogSxogSpogOogNogNaUnDnTnQanQinSxnSpnOnNnCtUc".split(/(?=[A-Z])/),[],"a b c d e f g h i j k l m n o p q r s t u v w x y z aa ab ac ad ae af ag ah ai aj ak al am an ao ap aq ar as at au av aw ax ay az ba bb bc bd be bf bg bh bi bj bk bl bm bn bo bp bq br bs bt bu bv bw bx by bz ca cb cc cd ce cf cg ch ci cj ck cl cm cn co cp cq cr cs ct cu cv cw cx".split(" "),"KMBTQaQiSxSpOcNoDcUdDdTdQadQidSxdSpdOdNdVUvDvTvQavQivSxvSpvOvNvTg".split(/(?=[A-Z])/)];window.addEventListener("error",function(a){return"string"==typeof a.error?void show_alert("ko",a.error):void create_share(function(b){return show_alert("ko","Oops! It’s not your fault, but something went wrong. You can go pester the dev on\n	<a href=https://github.com/Grimy/Grimy.github.io/issues/new>GitHub</a> or\n	<a href=https://www.reddit.com/message/compose/?to=Grimy_>Reddit</a>, he’ll fix it.\n	If you do, please include the following message:<br>\n	<tt>"+b+" "+a.filename+" l"+(a.lineno||0)+"c"+(a.colno||0)+" "+a.message+"</tt>.")})});var game;document.addEventListener("DOMContentLoaded",function(){var a="2.3";a>localStorage.version&&show_alert("ok","Welcome to Trimps tools v"+a+"! See what’s new in the <a href=changelog.html>changelog</a>."),localStorage.version=a,location.search&&load_share(location.search.substr(1)),$$("[data-saved]").forEach(function(a){"checkbox"===a.type?(a.checked="true"===localStorage[a.id],a.addEventListener("change",function(){return localStorage[a.id]=a.checked})):(a.value=localStorage[a.id]||a.value,a.addEventListener("change",function(){return localStorage[a.id]=a.value}))})},!1);var Perk=function(){function a(a,b,c,d,e,f){void 0===f&&(f=30),this.name=a,this.base_cost=b,this.increment=c,this.cap=d,this.free=e,this.scaling=f,this.locked=!0,this.level=0,this.pack=1,this.must=0,this.spent=0}return a.prototype.cost=function(){return this.increment?this.pack*(this.base_cost+this.increment*(this.level+(this.pack-1)/2)):ceil(this.level/2+this.base_cost*mult(this,this.scaling))},a}();document.addEventListener("DOMContentLoaded",validate_fixed,!1);var presets={early:["5","4","3"],broken:["7","3","1"],mid:["16","5","1"],corruption:["25","7","1"],magma:["35","4","3"],z280:["42","6","1"],z400:["88","10","1"],z450:["500","50","1"],spire:["0","1","1"],nerfed:["0","4","3"],tent:["5","4","3"],scientist:["0","1","3"],carp:["0","0","0"],trapper:["0","7","1"],coord:["0","40","1"],trimp:["0","99","1"],metal:["0","7","1"],c2:["0","7","1"]},add=function(a,b){return 1+a.level*b/100},mult=function(a,b){return pow(1+b/100,a.level)};