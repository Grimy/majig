"use strict";function validate_fixed(){try{parse_perks($("#fixed").value,"l"),$("#fixed").setCustomValidity("")}catch(a){$("#fixed").setCustomValidity(a)}}function select_preset(a){function b(b,c,d){c.value=c.value.replace(d,""),a.match(b)&&(c.value=d+c.value)}var c=presets[a];b(/spire|metal|trapper|carp/,$("#prod"),"0*"),b(/spire|carp/,$("#loot"),"0*"),b(/spire/,$("#fixed"),"overkill=0,"),b(/nerfed/,$("#fixed"),"overkill=1,"),b(/scientist/,$("#fixed"),"coord=0,"),b(/trapper/,$("#fixed"),"phero=0,anti=0,"),$("#weight-he").value=c[0],$("#weight-atk").value=c[1],$("#weight-hp").value=c[2]}function handle_respec(a){var b=game?game.resources.helium.owned:0;$("#helium").value=input("helium")+b*(a?-1:1)}function update_dg(){function a(a){m+=a*c*sqrt(min(d,n)),n-=h}var b=$("#zone").value/2+115,c=5e8+5e7*game.generatorUpgrades.Efficiency.upgrades,d=3+.4*game.generatorUpgrades.Capacity.upgrades,e=game.permanentGeneratorUpgrades.Storage.owned?1.5*d:d,f=230+2*game.generatorUpgrades.Supply.upgrades,g=game.generatorUpgrades.Overclocker.upgrades;g=g&&1-.5*pow(.99,g-1);var h=game.permanentGeneratorUpgrades.Slowburn.owned?.4:.5,i=game.talents.magmaFlow?18:16,j=game.talents.quickGen?1.03:1.02,k=game.talents.hyperspeed2?(game.global.highestLevelCleared+1)/2:0,l=.5*game.talents.blacksmith+.25*game.talents.blacksmith2+.15*game.talents.blacksmith3;l*=game.global.highestLevelCleared+1;for(var m=0,n=0,o=0,p=230;b>=p;++p){n+=i*(.01*min(p,f)-2.1);var q=ceil(60/pow(j,floor((p-230)/3)));for(o+=p>l?28:p>k?20:15;o>=q;)o-=q,a(1);for(;n>e;)a(g);m*=1.009}for(;n>=h;)a(1);$("#dg").value=floor(m)}function read_save(){localStorage.zone||($("#zone").value=game.stats.highestVoidMap.valueTotal);var a=$("#zone").value;localStorage["weight-he"]||localStorage["weight-atk"]||localStorage["weight-hp"]||($$("#preset > *").forEach(function(a){a.selected=+a.innerHTML.replace("z","")<game.global.highestLevelCleared}),select_preset($("#preset").value));var b=game.global.heliumLeftover;for(var c in game.portal)b+=game.portal[c].heliumSpent;var d=Object.keys(game.portal).filter(function(a){return!game.portal[a].locked});game.global.canRespecPerks||(d=d.map(function(a){return a+">"+game.portal[a].level}));var e=game.talents.turkimp4?1:game.talents.turkimp3?.6:game.talents.turkimp2?.4:game.talents.turkimp?.3:.25,f=1+e,g=1+.333*e,h=27*game.unlocks.imps.Jestimp+15*game.unlocks.imps.Chronoimp,i=60>a?0:85>a?7:160>a?10:185>a?14:20;h+=(game.talents.mapLoot2?5:4)*i;for(var j=0,k=game.global.StaffEquipped.mods||[];j<k.length;j++){var l=k[j];"MinerSpeed"===l[0]?f*=1+.01*l[1]:"metalDrop"===l[0]&&(g*=1+.01*l[1])}update_dg(),$("#helium").value=b+($("#respec").checked?0:game.resources.helium.owned),$("#unlocks").value=d.join(","),$("#whipimp").checked=game.unlocks.imps.Whipimp,$("#magnimp").checked=game.unlocks.imps.Magnimp,$("#tauntimp").checked=game.unlocks.imps.Tauntimp,$("#venimp").checked=game.unlocks.imps.Venimp,$("#chronojest").value=h,$("#prod").value=($("#prod").value.startsWith("0*")?"0*":"")+prettify(f),$("#loot").value=($("#loot").value.startsWith("0*")?"0*":"")+prettify(g),$("#breed-timer").value=game.talents.patience?45:30}function display(a){var b=a[0],c=a[1];$("#results").style.opacity=1,$("#info").innerText=localStorage.more?"Less info":"More info",$("#he-left").innerHTML=prettify(b)+" Helium Left Over",$("#perks").innerHTML=c.filter(function(a){return!a.locked}).map(function(a){var b=a.name,c=a.level,d=a.cap,e=a.spent,f=game?c-game.portal[a.name].level:0,g=f?" ("+(f>0?"+":"-")+prettify(abs(f))+")":"",h=f>0?"adding":0>f?"remove":c>=d?"capped":"";return"<div class='perk "+h+" "+localStorage.more+"'>"+("<b>"+b.replace("_"," ")+"</b><br>")+("Level: <b>"+prettify(c)+g+"</b><br><span class=more>")+("Price: "+(c>=d?"∞":prettify(a.cost()))+"<br>")+("Spent: "+prettify(e)+"</span></div>")}).join("")}function main(){var a=$("#preset").value;if("trapper"==a&&(!game||"Trapper"!=game.global.challengeActive))return void show_alert("ko","This preset requires a save currently running Trapper². Start a new run using “Trapper² (initial)”, export, and try again.");var b=parse_inputs(a),c=game?game.global.highestLevelCleared:999;(a.match(/trimp|coord/)&&b.zone>=c/2||"trapper"===a&&b.zone>=c-40)&&show_alert("warning","Your target zone seems too high for this c², try lowering it."),"spire"==a&&game&&game.global.world!=100*(2+game.global.lastSpireCleared)&&show_alert("warning","This preset is meant to be used mid-run, when you’re done farming for the Spire."),display(optimize(b))}function toggle_info(){localStorage.more=localStorage.more?"":"more",$$(".perk").forEach(function(a){return a.classList.toggle("more")}),$("#info").innerText=localStorage.more?"Less info":"More info"}function parse_perks(a,b){var c=[new Perk("Looting_II",1e5,1e4,1/0,1e4),new Perk("Carpentry_II",1e5,1e4,1/0,1e4),new Perk("Motivation_II",5e4,1e3,1/0,1e4),new Perk("Power_II",2e4,500,1/0,1e4),new Perk("Toughness_II",2e4,500,1/0,1e4),new Perk("Overkill",1e6,0,30,1e4),new Perk("Resourceful",5e4,0,1/0,1e6),new Perk("Coordinated",15e4,0,1/0,1e4),new Perk("Siphonology",1e5,0,3,1e4),new Perk("Anticipation",1e3,0,10,1e4),new Perk("Resilience",100,0,1/0,1e4),new Perk("Meditation",75,0,7,1e4),new Perk("Relentlessness",75,0,10,1e4),new Perk("Carpentry",25,0,1/0,1e4),new Perk("Artisanistry",15,0,1/0,1e4),new Perk("Range",1,0,10,1e4),new Perk("Agility",4,0,20,1e4),new Perk("Bait",4,0,1/0,1e7),new Perk("Trumps",3,0,1/0,1e8),new Perk("Pheromones",3,0,1/0,1e6),new Perk("Packrat",3,0,1/0,1e7),new Perk("Motivation",2,0,1/0,1e4),new Perk("Power",1,0,1/0,1e4),new Perk("Toughness",1,0,1/0,1e4),new Perk("Looting",1,0,1/0,1e4)];b.match(/>/)||(b=b.replace(/(?=,|$)/g,">0"));for(var d=function(a){var b=a.match(/(\S+) *([<=>])=?(.*)/);if(!b)throw"Enter a list of perk levels, such as “power=42, toughness=51”";var d=b[1].match(/2$|II$/),e=b[1].replace(/[ _]?(2|II)/i,"").replace(/^OK/i,"O").replace(/^Looty/i,"L"),f=new RegExp("^"+e+"[a-z]*"+(d?"_II":"")+"$","i"),g=c.filter(function(a){return a.name.match(f)});if(g.length>1)throw"Ambiguous perk abbreviation: "+b[1]+".";if(g.length<1)throw"Unknown perk: "+b[1]+".";var h=parse_suffixes(b[3]);if(!isFinite(h))throw"Invalid number: "+b[3]+".";g[0].locked=!1,">"!=b[2]&&(g[0].cap=h),"<"!=b[2]&&(g[0].must=h)},e=0,f=(b+","+a).split(/,/).filter(function(a){return a});e<f.length;e++){var g=f[e];d(g)}return c}function optimize(a){function b(){return 1+ +(H.level<3)+ceil(10*mult(H,-5))}function c(a){var c=q.storage*mult(x,-5)/add(L,20),d=fa()*q.magn/b(),e=a?0:ea()*add(C,1)*q.prod,f=.1*q.chronojest*e*d;return _*(e+d*q.loot+f)*(1-c)}function d(a){var b=da[a]*mult(F,-5),d=1.136,e=log(1+c()*ga()/b)/log(ca.cost);return e>ba+.45&&(d=log(1+.2*pow(ca.cost,e-ba))/log(1.2),e=ba),d*pow(ca[a],e)}function e(a,b){return a*=4*mult(x,-5),log(1+c(!0)*ga()*(b-1)/a)/log(b)}function f(){return max(n-229,0)}function g(){var a=e(2e6,1.06)/(1+.1*min(f(),20)),b=.0085*(n>=60?.1:1)*pow(1.1,floor(n/5));return b*pow(1.01,a)*add(K,10)*q.ven}function h(){var a=1+.25*mult(y,-2),b=(q.soldiers||ga())/3;q.soldiers>1&&(b+=36e3*add(I,100));var c=log(b/ha[y.level])/log(a),d=n-1+(f()?100:0);return ha[0]*pow(1.25,min(c,d))}function i(){var a=(.15+d("attack"))*pow(.8,f());return a*=add(N,5)*add(u,1),a*=add(D,5*add(D,30)),a*=pow(1+z.level,.1)*add(G,1),a*=add(A,6),h()*a}function j(){var a=(.6+d("health"))*pow(.8,f());a*=add(O,5)*add(v,1)*mult(B,10);var c=e(400,1.185),i=(c*log(1.185)-log(1+c))/log(1.1)+25-Z,j=.04*c*pow(1+Z/100,c)*(1+$*i),k=60;if(70>n){var l=log(1+h()*g()/add(I,100))/log(1+g());k=l/b()}else{var m=1+.25*mult(y,-2),o=n-1+(f()?100:0),p=ha[y.level]*pow(m,o),r=min(p/ga(),1/3),s=r>1e-9?10*(pow(.5/(.5-r),.1/q.breed_timer)-1):r/q.breed_timer,t=log(g()/s)/-log(.98);a*=pow(1.01,t)}return a/=k,60>n?j+=d("block"):j=min(j,4*a),h()*(j+a)}function k(){var a=0;for(var b in p)if(p[b]){var c=pa[b]();if(!isFinite(c))throw Error(b+" is "+c);a+=p[b]*log(c)}return a}function l(){for(var a=0,b=o;a<b.length;a++){var c=b[a];if(c.level<c.must)return c}for(var d,e=0,f=k(),g=0,h=o;g<h.length;g++){var c=h[g];if(!(c.locked||c.level>=c.cap||c.cost()>m||c==I&&n>=100)){c.level+=c.pack;var i=k()-f;c.level-=c.pack;var j=i/c.cost();j>=e&&(e=j,d=c)}}return d}for(var m=a.he_left,n=a.zone,o=a.perks,p=a.weight,q=a.mod,r=o[0],s=o[1],t=o[2],u=o[3],v=o[4],w=o[5],x=o[6],y=o[7],z=o[8],A=o[9],B=o[10],C=o[11],D=o[12],E=o[13],F=o[14],G=o[15],H=o[16],I=o[17],J=o[18],K=o[19],L=o[20],M=o[21],N=o[22],O=o[23],P=o[24],Q=0,R=o;Q<R.length;Q++){var S=R[Q];S.name.endsWith("_II")&&(S.pack=pow(10,max(0,floor(log(m)/log(100)-4.2))))}for(var T=0,U=["whip","magn","taunt","ven"];T<U.length;T++){var V=U[T];q[V]=pow(1.003,99*n*.03*q[V])}for(var W=pow(1.25,n)*pow(n>100?1.28:1.2,max(n-59,0)),X=max(0,min(n-60,n/2-25,n/3-12,n/5,n/10+17,39)),Y=pow(1.25,min(n/2,30)+X),Z=n>=25?floor(min(n/5,9+n/25,15)):0,$=(20+n-n%5)/100,_=600*q.whip*W,aa=pow(n-19,2),ba=n/5+ +(5>(n-1)%10),ca={cost:pow(1.069,.85*(60>n?57:53)),attack:pow(1.19,13),health:pow(1.19,14),block:pow(1.19,10)},da={attack:211*(p.attack+p.health)/p.attack,health:248*(p.attack+p.health)/p.health,block:5*(p.attack+p.health)/p.health},ea=function(){return add(M,5)*add(t,1)},fa=function(){return add(P,5)*add(r,.25)},ga=q.tent_city?function(){var a=mult(E,10)*add(s,.25),b=add(J,20);return 10*(q.taunt+b*(q.taunt-1)*111)*a}:function(){var a=mult(E,10)*add(s,.25),b=3+max(log(c()/_*a/mult(x,-5)),0),d=add(J,20)*n;return 10*(Y*b+d)*a*q.taunt+q.dg*a},ha=[],ia=0;ia<=log(1+m/5e5)/log(1.3);++ia){for(var ja=1+.25*pow(.98,ia),ka=1,la=0;100>la;++la)ka=ceil(ka*ja);ha[ia]=ka/pow(ja,100)}var ma=function(){return 1/mult(H,-5)},na=function(){return aa*fa()+45},oa=function(){return add(w,100)},pa={agility:ma,helium:na,attack:i,health:j,overkill:oa,trimps:ga};q.loot*=20.8*(.7+.3*floor((n+1)/101)),p.agility=(p.helium+p.attack)/2,p.overkill=.25*p.attack*(2-pow(.9,p.helium/p.attack));for(var qa=void 0;qa=l();){for(var ra=0;qa.level<qa.cap&&(qa.level<qa.must||ra<m/qa.free);)m-=qa.cost(),ra+=qa.cost(),qa.level+=qa.pack,qa.level==1e3*qa.pack&&(qa.pack*=10);qa.spent+=ra}for(var sa=0,ta=o;sa<ta.length;sa++){var S=ta[sa];console.log(S.name,"=",S.level)}return[m,o]}var Perk=function(){function a(a,b,c,d,e){this.name=a,this.base_cost=b,this.increment=c,this.cap=d,this.free=e,this.locked=!0,this.level=0,this.pack=1,this.must=0,this.spent=0}return a.prototype.cost=function(){return this.increment?this.pack*(this.base_cost+this.increment*(this.level+(this.pack-1)/2)):ceil(this.level/2+this.base_cost*mult(this,30))},a}();validate_fixed();var presets={pick:["","",""],early:[5,4,3],broken:[7,3,1],mid:[16,5,1],corruption:[25,7,1],magma:[35,4,3],z280:[42,6,1],z400:[88,10,1],z450:[500,50,1],spire:[0,1,1],nerfed:[0,4,3],tent:[5,4,3],scientist:[0,1,3],carp:[0,0,0],trapper:[0,7,1],coord:[0,40,1],trimp:[0,99,1],metal:[0,7,1],c2:[0,7,1]},parse_inputs=function(a){return{he_left:"nerfed"==a?1e8:input("helium"),zone:"nerfed"==a?200:parseInt($("#zone").value),perks:parse_perks($("#fixed").value,$("#unlocks").value),weight:{helium:input("weight-he"),attack:input("weight-atk"),health:input("weight-hp"),trimps:"carp"==a?1e6:0},mod:{storage:.125,dg:"nerfed"==a?0:input("dg"),soldiers:"trapper"==a?game.resources.trimps.owned:"trimp"==a,tent_city:"tent"==a,whip:$("#whipimp").checked,magn:$("#magnimp").checked,taunt:$("#tauntimp").checked,ven:$("#venimp").checked,chronojest:input("chronojest"),prod:input("prod"),loot:input("loot"),breed_timer:input("breed-timer")}}},add=function(a,b){return 1+a.level*b/100},mult=function(a,b){return pow(1+b/100,a.level)};