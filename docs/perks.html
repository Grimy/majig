<!DOCTYPE html>
<meta charset=UTF-8>
<title>Perky</title>
<link href=blue.css rel=stylesheet>
<link href=dark.css rel=stylesheet id=dark>
<style>
#results { flex: 2 0 640px; margin: 0 auto; white-space: nowrap }
#details > * { flex: 1 0; align-self: center; margin: 0 1em }
#perks { justify-content: center }
fieldset { flex: 2 0 320px }
.perk { width: 20%; text-align: center; overflow: hidden }
.perk { border: 1px solid black; margin: -1px; padding: 0.6ex 0 0.4ex 0 }
.perk { box-shadow: inset 0 0 1px white, 1px 1px 2px #000; font-size: 1.05rem }
.perk { background: #666; color: white }
.perk.capped { background: #696980 }
.perk.adding { background: #809080 }
.perk.remove { background: #806969 }
.perk:not(.more) > .more { display: none }
.perk.more { line-height: 105% }
</style>

<h1>Perk Optimizer</h1>

<p id=alert></p>

<form class=flexbox action='javascript:try_main()'>
	<div class=filler></div>

	<fieldset class=box>
		<legend>Inputs</legend>

		<label title='Export your Trimps save and paste it here.'>
			<textarea id=save onfocus='this.value = ""' onpaste='handle_paste(event)'></textarea>
			Import save
		</label>

		<label title='Check this when respeccing from the View Perks screen.'>
			<input type=checkbox id=respec onchange='handle_respec(this.checked)'>
			Mid-run respec
		</label>

		<label title='The base zone used in calculations. Set this to a few zone before your planned portalling zone, for example the zone on which you do your Void Maps.'>
			<input type=text id=zone required pattern='\d{2,3}' onchange='if (game) update_dg()' data-saved>
			Target zone
		</label>

		<label title='Suggested weights far various situations.'>
			<select id=preset onchange='select_preset(this.value)'>
				<option value=pick>
				<option disabled>— Normal progression —
				<option value=early>z1–59
				<option value=broken>z60–99
				<option value=mid>z100–180
				<option value=corruption>z181–229
				<option value=magma>z230–280
				<option value=z280>z280–400
				<option value=z400>z400–450
				<option value=z450>z450+
				<option disabled>— Special-purpose presets —
				<option value=spire>Spire respec
				<option value=nerfed>Nerfed feat
				<option value=tent>Tent City feat
				<option value=scientist>Scientist challenge
				<option value=carp>Trapper² (initial)
				<option value=trapper>Trapper² (respec)
				<option value=coord>Coordinate²
				<option value=trimp>Trimp²
				<option value=metal>Metal²
				<option value=c2>Other c²
			</select>
			Presets
		</label>

		<label title='How much you value +1% Helium income.'>
			<input type=text id=weight-he oninput='check_input(this)' required data-saved>
			Weight: Helium
		</label>

		<label title='How much you value +1% attack.'>
			<input type=text id=weight-atk oninput='check_input(this)' required data-saved>
			Weight: Attack
		</label>

		<label title='How much you value +1% survivability (health and block).'>
			<input type=text id=weight-hp oninput='check_input(this)' required data-saved>
			Weight: Health
		</label>

		<label title='A list of perks that you don’t want to change, for example “power=42, carp=31”'>
			<input type=text id=fixed oninput='validate_fixed()' data-saved>
			Fixed perks
		</label>

		<div class=tabs>
		<label for=advanced>Toggle manual input</label>
		<input type=checkbox id=advanced data-saved>

		<label title='Total Helium Earned, as displayed on the Stats screen'>
			<input type=text id=helium required oninput='check_input(this)'>
			Total Helium
		</label>

		<label title='Number of trimps generated by your DG (before carpentry)'>
			<input type=text id=dg value=0 oninput='check_input(this)'>
			DG housing
		</label>

		<label title='A comma-separated list of perks you have unlocked'>
			<input type=text id=unlocks value='Agility,Bait,Trumps,Pheromones,Packrat,Motivation,Power,Toughness,Looting'>
			Unlocked perks
		</label>

		<label title='Uncheck this if you didn’t unlock the Whipimp'>
			<input type=checkbox checked id=whipimp>
			Whipimp
		</label>

		<label title='Uncheck this if you didn’t unlock the Magnimp'>
			<input type=checkbox checked id=magnimp>
			Magnimp
		</label>

		<label title='Uncheck this if you didn’t unlock the Tauntimp'>
			<input type=checkbox checked id=tauntimp>
			Tauntimp
		</label>

		<label title='Uncheck this if you didn’t unlock the Venimp'>
			<input type=checkbox checked id=venimp>
			Venimp
		</label>

		<label title='Seconds of income per 100 cells cleared. This includes Chronoimp, Jestimp, and caches.'>
			<input type=text id=chronojest value=42 pattern='\d+'>
			Chronojest mod
		</label>

		<label title='Multiplier for production'>
			<input type=text id=prod oninput='check_input(this)' value=1>
			Production mod
		</label>

		<label title='Multiplier for regular loot'>
			<input type=text id=loot oninput='check_input(this)' value=1>
			Loot mod
		</label>

		<label title='Your usual breed timer'>
			<input type=text id=breed-timer value=30 pattern='\d+'>
			Breed timer
		</label>
		</div>

		<button type=submit class=centered>Optimize!</button>
	</fieldset>

	<div class=filler></div>
	<div class=filler></div>

	<div id=results style='opacity: 0'>
		<div id=details class=flexbox>
			<h2 id=he-left></h2>
			<button type=button id=info onclick='toggle_info()'></button>
			<button type=button onclick='create_share()'>Share</button>
		</div>
		<div id=perks class=flexbox></div>
	</div>

	<div class=filler></div>
</form>

<nav class=flexbox>
	<a href=zfarm.html>zFarm</a>
	<a href=perks.html class=active>Perky</a>
	<span class=centered></span>
	<a onclick='switch_theme()'>Switch theme</a>
	<a href=changelog.html>Changelog</a>
	<a href='https://github.com/Grimy/Grimy.github.io/issues/new'>Report a bug</a>
	<a href='https://github.com/Grimy/Grimy.github.io/blob/master/perks.js'>View the source</a>
	<a href='https://github.com/Grimy'>By Grimy</a>
</nav>

<script src=/lz-string.js></script>
<script src=trimps.js></script>
<script src=perks.js></script>
<script>
"use strict";

function validate_fixed() {
	try {
		parse_perks($('#fixed').value, 'l');
		$('#fixed').setCustomValidity('');
	} catch (err) {
		$('#fixed').setCustomValidity(err);
	}
}

validate_fixed();

function select_preset(name) {
	let preset = {
		pick:       [ '', '', ''],
		early:      [  5,  4,  2],
		broken:     [  7,  3,  1],
		mid:        [ 16,  5,  1],
		corruption: [ 25,  7,  1],
		magma:      [ 35,  4,  3],
		z280:       [ 42,  6,  1],
		z400:       [ 88, 10,  1],
		z450:       [500, 50,  1],
		spire:      [  0,  1,  1],
		nerfed:     [  0,  4,  3],
		tent:       [  5,  4,  3],
		scientist:  [  0,  1,  3],
		carp:       [  0,  0,  0],
		trapper:    [  0,  7,  1],
		coord:      [  0, 40,  1],
		trimp:      [  0, 99,  1],
		metal:      [  0,  7,  1],
		c2:         [  0,  7,  1],
	}[name];

	function special(regex, field, prefix) {
		field.value = field.value.replace(prefix, '');
		if (name.match(regex))
			field.value = prefix + field.value;
	}

	special(/spire|metal|trapper|carp/, $('#prod'), '0*');
	special(/spire|carp/, $('#loot'), '0*');
	special(/spire/, $('#fixed'), 'overkill=0,');
	special(/nerfed/, $('#fixed'), 'overkill=1,');
	special(/scientist/, $('#fixed'), 'coord=0,');
	special(/trapper/, $('#fixed'), 'phero=0,anti=0,');

	[$('#weight-he').value, $('#weight-atk').value, $('#weight-hp').value] = preset;
}

function handle_respec(respec) {
	let owned = game ? game.resources.helium.owned : 0;
	$('#helium').value = input('helium') + owned * (respec ? -1 : 1);
}

function update_dg() {
	let max_zone = $('#zone').value / 2 + 115;
	let eff = 500e6 + 50e6 * game.generatorUpgrades.Efficiency.upgrades;
	let capa = 3 + 0.4 * game.generatorUpgrades.Capacity.upgrades;
	let max_fuel = game.permanentGeneratorUpgrades.Storage.owned ? capa * 1.5 : capa;
	let supply = 230 + 2 * game.generatorUpgrades.Supply.upgrades;
	let overclock = game.generatorUpgrades.Overclocker.upgrades;
	overclock = overclock && (1 - 0.5 * pow(0.99, overclock - 1));
	let burn = game.permanentGeneratorUpgrades.Slowburn.owned ? 0.4 : 0.5;
	let cells = game.talents.magmaFlow ? 18 : 16;
	let accel = game.talents.quickGen ? 1.03 : 1.02;
	let speed = game.talents.hyperspeed ? 20 : 25;
	let hs2 = game.talents.hyperspeed2 ? (game.global.highestLevelCleared + 1) / 2 : 0;
	let bs = 0.5*game.talents.blacksmith + 0.25*game.talents.blacksmith2 + 0.15*game.talents.blacksmith3;
	bs *= game.global.highestLevelCleared + 1;
	let housing = 0;
	let fuel = 0;
	let time = 0;

	function tick(mult) {
		housing += mult * eff * sqrt(min(capa, fuel));
		fuel -= burn;
	}

	for (let zone = 230; zone <= max_zone; ++zone) {
		fuel += cells * (0.01 * min(zone, supply) - 2.1);

		let tick_time = ceil(60 / pow(accel, floor((zone - 230) / 3)));
		time += zone > bs ? 28 : zone > hs2 ? 20 : 15;
		while (time >= tick_time) {
			time -= tick_time;
			tick(1);
		}

		while (fuel > max_fuel)
			tick(overclock)

		housing *= 1.009;
	}

	while (fuel >= burn)
		tick(1);

	$("#dg").value = floor(housing);
}

function read_save() {
	// Auto-fill for the lazy
	if (!localStorage.zone)
		$('#zone').value = game.global.highestLevelCleared - 5;

	if (!localStorage['weight-he'] && !localStorage['weight-atk'] && !localStorage['weight-hp']) {
		let option;
		$$('#preset > *').forEach(function (x) {
			if (parseInt(x.innerHTML.replace('z', '')) < game.global.highestLevelCleared)
				option = x;
		});
		option.selected = true;
		select_preset(option.value);
	}

	// He / unlocks
	let helium = game.global.heliumLeftover;
	for (let perk in game.portal)
		helium += game.portal[perk].heliumSpent;

	let unlocks = Object.keys(game.portal).filter(perk => !game.portal[perk].locked);
	if (!game.global.canRespecPerks)
		unlocks = unlocks.map(perk => perk + '>' + game.portal[perk].level);

	// Income
	let tt = game.talents.turkimp4 ? 1 :
	         game.talents.turkimp3 ? 0.6 :
	         game.talents.turkimp2 ? 0.4 :
	         game.talents.turkimp ? 0.3 : 0.25;
	let prod = 1 + tt;
	let loot = 1 + 0.333 * tt;
	let chronojest = 27 * game.unlocks.imps.Jestimp + 15 * game.unlocks.imps.Chronoimp;
	let cache = zone < 60 ? 0 : zone < 85 ? 7 : zone < 160 ? 10 : zone < 185 ? 14 : 20;
	chronojest += (game.talents.mapLoot2 ? 5 : 4) * cache;

	for (let mod of (game.global.StaffEquipped.mods || [])) {
		if (mod[0] === 'MinerSpeed')
			prod *= 1 + 0.01 * mod[1];
		else if (mod[0] === 'metalDrop')
			loot *= 1 + 0.01 * mod[1];
	}

	// Fill the fields
	update_dg();
	$('#helium').value = helium + ($('#respec').checked ? 0 : game.resources.helium.owned);
	$('#unlocks').value = unlocks.join(',');
	$('#whipimp').checked = game.unlocks.imps.Whipimp;
	$('#magnimp').checked = game.unlocks.imps.Magnimp;
	$('#tauntimp').checked = game.unlocks.imps.Tauntimp;
	$('#venimp').checked = game.unlocks.imps.Venimp;
	$('#chronojest').value = chronojest;
	$('#prod').value = ($('#prod').value.startsWith('0*') ? '0*' : '') + prettify(prod);
	$('#loot').value = ($('#loot').value.startsWith('0*') ? '0*' : '') + prettify(loot);
	$('#breed-timer').value = game.talents.patience ? 45 : 30;
}

const parse_inputs = (preset) => ({
	he_left: preset == 'nerfed' ? 1e8 : input('helium'),
	zone: preset == 'nerfed' ? 200 : parseInt($('#zone').value),
	perks: parse_perks($('#fixed').value, $('#unlocks').value),
	weight: {
		helium: input('weight-he'),
		attack: input('weight-atk'),
		health: input('weight-hp'),
		trimps: preset == 'carp' ? 1e6 : 0,
	},
	mod: {
		storage: 0.125,
		dg: input('dg'),
		soldiers: preset == 'trapper' ? game.resources.trimps.owned : preset == 'trimp',
		tent_city: preset == 'tent',
		whip: $('#whipimp').checked,
		magn: $('#magnimp').checked,
		taunt: $('#tauntimp').checked,
		ven: $('#venimp').checked,
		chronojest: input('chronojest'),
		prod: input('prod'),
		loot: input('loot'),
		breed_timer: input('breed-timer'),
	}
});

function display(results) {
	let [he_left, perks] = results;

	$('#results').style.opacity = 1;
	$('#info').innerText = localStorage.more ? 'Less info' : 'More info';
	$('#he-left').innerHTML = prettify(he_left) + ' Helium Left Over';
	$('#perks').innerHTML = perks.filter(p => !p.locked).map(perk => {
		let {name, level, cap, spent} = perk;
		let diff = game ? level - game.portal[perk.name].level : 0;
		let diff_text = diff ? ` (${diff > 0 ? '+' : '-'}${prettify(abs(diff))})` : '';
		let style = diff > 0 ? 'adding' : diff < 0 ? 'remove' : level >= cap ? 'capped' : '';

		return `<div class='perk ${style} ${localStorage.more}'>`
			+ `<b>${name.replace('_', ' ')}</b><br>`
			+ `Level: <b>${prettify(level)}${diff_text}</b><br><span class=more>`
			+ `Price: ${level >= cap ? '∞' : prettify(perk.cost())}<br>`
			+ `Spent: ${prettify(spent)}</span></div>`;
	}).join('');
}

function main() {
	let preset = $('#preset').value;

	if (preset == 'trapper' && (!game || game.global.challengeActive != 'Trapper')) {
		show_alert('ko', 'This preset requires a save currently running Trapper². Start a new run using “Trapper² (initial)”, export, and try again.');
		return;
	}

	let inputs = parse_inputs(preset);
	let max_zone = game ? game.global.highestLevelCleared : 999;

	if ((preset.match(/trimp|coord/) && inputs.zone >= max_zone / 2)
			|| (preset === 'trapper' && inputs.zone >= max_zone - 40))
		show_alert('warning', 'Your target zone seems too high for this c², try lowering it.');

	if (preset == 'spire' && game && game.global.world != 100 * (2 + game.global.lastSpireCleared))
		show_alert('warning', 'This preset is meant to be used mid-run, when you’re done farming for the Spire.');

	display(optimize(inputs));
}

function toggle_info() {
	localStorage.more = localStorage.more ? '' : 'more';
	$$('.perk').forEach(elem => elem.classList.toggle('more'));
	$('#info').innerText = localStorage.more ? 'Less info' : 'More info';
}

</script>
